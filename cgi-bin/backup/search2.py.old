#!/usr/local/bin/python

from pgext import *
from cgi import *
import os, string,sys, regsub, math

mydbase = connect("c2w")

def SendError(str):
    errmsg = escape(str)
    print "Content-type: text/html\n\n"
    print "<HEADER>\n<TITLE> CGI Error </TITLE>\n</HEADER>\n"
    print "<BODY bgcolor=#FFFFFF>\n"
    print "<H1>CGI Error</H1>\n"
    print "<H3><STRONG>" + errmsg + "</STRONG></H3>\n"
    print "</BODY>"
    sys.exit(0)

def Main():
	dresults = ""
	fresults = ""
	bresults = ""	

	form = FormContent()
	string = form["string"][0]
	field = form["field"][0]
	filename = form["filename"][0]

	if filename == "all": filename = "%"

	if not form.has_key("string"): SendError("You did not input a search string")
	if not form.has_key("field"): SendError("no search field found")

	print "Content-type: text/html\n\n"
	print "<HEADER>\n<TITLE>C2W Search Results</TITLE>\n</HEADER>\n"
	print "<BODY bgcolor=#FFFFFF>\n"
	print '<a href="http://www.pals.iastate.edu/c2w/adm/search.html">New Search</a>'

	if field == "description":
		dresults = mydbase.query("select * from movies where description ~~ '%"+string+"%' AND filename ~~ '"+filename+"%'")
		dresults = dresults.getresult()

	elif field == "filename":
		fresults = mydbase.query("select * from movies where filename ~~ '"+filename+"%"+string+"%'")
		fresults = fresults.getresult()

	elif field == "both":
		bresults = mydbase.query("select * from movies where description ~~ '%"+string+"%' OR filename ~~ '%"+string+"%'")
		bresults = bresults.getresult()
	
	if len(dresults) == 0: total = 0	
	if len(fresults) == 0: total = 0
	if len(bresults) == 0: total = 0

  	if len(dresults) > 0: total = len(dresults) 
	if len(fresults) > 0: total = len(fresults) 
	if len(bresults) > 0: total = len(bresults)

	
	print '<center>\n<h3>Results of the search for "'+string+'"</h3>\n</center>\n'
	print '<dl>\n'

	if len(dresults) > 0:
		for item in range(len(dresults)):
			print "<P>\n"
			print "<dt>\n"
			print item+1
			print ")"
			print '<IMG SRC="http://www.pals.iastate.edu/images/point_02.gif">'
			print '<a href="'+dresults[item][0]+'">'+dresults[item][0]+'</a>'
			size = int(dresults[item][4])
			if size >= 1024000:
				size = (size)/(1024000)
				tag = "MB"
			else:
				size = (size)/(1024)
				tag = "K"
			print '(size =',size,' '+tag+')<br>'
			print '<dd>(Filename = <b>'+dresults[item][1]+'</b>) -- '
	        	print dresults[item][3] + '<br>\n'  

	elif len(fresults) > 0:
		for item in range(len(fresults)):
			print "<P>\n" 
                	print "<dt>\n" 
                	print item+1
               		print ")" 
                	print '<IMG SRC="http://www.pals.iastate.edu/images/point_02.gif">'
                	print '<a href="'+fresults[item][0]+'">'+fresults[item][0]+'</a>'
			size = int(fresults[item][4])
                        if size >= 1024000: 
                                size = (size)/(1024000) 
                                tag = "MB" 
                        else: 
                                size = (size)/(1024) 
                                tag = "K" 
                        print '(size =',size,' '+tag+')<br>'
                	print '<dd>(Filename = <b>'+fresults[item][1]+'</b>) -- '
                	print fresults[item][3] + '<br>\n'

	elif len(bresults) > 0:
		for item in range(len(bresults)):
			print "<P>\n" 
                	print "<dt>\n" 
                	print item+1
                	print ")" 
                	print '<IMG SRC="http://www.pals.iastate.edu/images/point_02.gif">'
                	print '<a href="'+bresults[item][0]+'">'+bresults[item][0]+'</a>'
                	size = int(bresults[item][4]) 
                        if size >= 1024000: 
                                size = (size)/(1024000) 
                                tag = "MB" 
                        else: 
                                size = (size)/(1024) 
                                tag = "K" 
                        print '(size =',size,' '+tag+')<br>'
			print '<dd>(Filename = <b>'+bresults[item][1]+'</b>) -- '
                	print bresults[item][3] + '<br>\n'

	else:		
		print "No results were found"

	print '</dl>\n'
	print '</html>\n'
	
Main()
	
