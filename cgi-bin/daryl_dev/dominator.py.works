#!/usr/local/bin/python
# Daryl Herzmann 7/13/98

import sys, re, regsub, os, urllib, urlparse, regex, string
from cgi import *

def html_getter(url, file):
	if file != "none":
		url = urlparse.urljoin(url,file)
	 

        f = urllib.urlopen(url) 
        page = f.readlines() 
	hidden = "no"
	another = "no"
        for i in range(len(page)): 
                if another == "yes":
			another = "notyet"
		if hidden == "yes":
                        if another == "now":	
				print '<input type="hidden" name="url" value="'+url+'">'
			elif another == "no":
				print '<input type="hidden" name="url" value="'+url+'">'
		if another != "notyet":
			hidden = "no"

		line = page[i]
		if string.find(line, 'href="') != -1: 
			line = regsub.gsub('href="','href="http://www.pals.iastate.edu/cgi-bin/daryl_dev/dominator.py?url='+url+'&file=',line)

		if string.find(line, 'HREF="') != -1: 
			line = regsub.gsub('HREF="','href="http://www.pals.iastate.edu/cgi-bin/daryl_dev/dominator.py?url='+url+'&file=',line)
		
		if string.find(line, 'ACTION="') != -1: 
                        line = regsub.gsub('ACTION="','ACTION="http://www.pals.iastate.edu/cgi-bin/daryl_dev/dominator.py"> <input type="hidden" name="cgifile" value="',line) 
                        first = line[:-3]
                        second = '?">'   
                        line = first+second

		if string.find(line, 'action="') != -1:
		      	line = regsub.gsub('action="','ACTION="http://www.pals.iastate.edu/cgi-bin/daryl_dev/dominator.py"> <input type="hidden" name="cgifile" value="',line) 
			first = line[:-3]
			second = '?">'
			line = first+second

		if string.find(line, 'BASE HREF') != -1: 
                        line = regsub.gsub('<BASE HREF=','<FONT=',line)

		if string.find(line, 'base href') != -1: 
                        line = regsub.gsub('<base href=','<FONT=',line)
		
		if string.find(line, 'BASE href') != -1: 
                        line = regsub.gsub('<BASE href=','<FONT=',line) 

		if string.find(line, '=POST') != -1: 
                	line = regsub.gsub('=POST','=GET',line)
			hidden = "yes"
			halves = string.split('=POST','line',1)
			if string.find(halves[1], '>') != -1:
				another = "no"
			else:
				another = "yes"
	
		if string.find(line, '="POST"') != -1: 
                        line = regsub.gsub('="POST"','="GET"',line)
			hidden = "yes"
			halves = string.split('="POST"','line',1)
                        if string.find(halves[0][1], '>') != -1:
                                another = "no"
                        else:
                                another = "yes"
		if string.find(line, '=post') != -1:
                        line = regsub.gsub('=post','="GET"',line)
                        hidden = "yes"
                        halves = string.split('=post','line',1)
                        if string.find(halves[0][1], '>') != -1:
                                another = "no"
                        else:
                                another = "yes"
		if string.find(line, '="post"') != -1:
                        line = regsub.gsub('="post""','="GET"',line)
                        hidden = "yes"
                        halves = string.split('="post"','line',1)
                        if string.find(halves[0][1], '>') != -1:
                                another = "no"
                        else:
                                another = "yes"

		if string.find(line, '404 Not found') != -1: 
			print '<H1>Dominator is having trouble loading this page.</H1>'
			sys.exit()
		if string.find(line, 'moved path') != -1: 
                        print '<H1>Dominator is having trouble loading this page.</H1>'
                        sys.exit()		
		print line
		if another == "notyet":
			another = "now"	


def Main():
	form = FormContent()
	file = "none"
	url = "http://pals.agron.iastate.edu/home/dominator.html"
	if form.has_key("url"): url = form["url"][0]
        if form.has_key("file"): file = form["file"][0]
	if form.has_key("cgifile"): file = form["cgifile"][0]
	print "Content-type: text/html\n\n"  
	print '<header>\n'
	base = url
	if file[0] == "h":
		base = file
	elif file[0] != "none":
		if file[0] != "h":
			base = urlparse.urljoin(url,file)

	## Need to make the base url trail with a /##
		
	base = urlparse.urlparse(base)
	if base[0][2] == '':
		base[0][2] = '/'
	base = urlparse.urlunparse(base)

	print '<base href="'+base+'">'
	print '<title>Dominator</title>\n</header>\n'  
	html_getter(url, file) 

Main()
