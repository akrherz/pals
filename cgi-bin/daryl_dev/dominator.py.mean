#!/usr/local/bin/python

import sys, re, regsub, os, urllib, urlparse, regex, string
from cgi import *

def html_getter(url, file):
	if file != "none":
		url = urlparse.urljoin(url,file)
	 

        f = urllib.urlopen(url) 
        page = f.readlines() 

        for i in range(len(page)): 
                line = page[i]
		if string.find(line, 'href="') != -1: 
			line = regsub.gsub('href="','href="http://www.pals.iastate.edu/cgi-bin/daryl_dev/dominator.py?url='+url+'&file=',line)


               	if string.find(line, 'HREF="') != -1: 
			line = regsub.gsub('HREF="','href="http://www.pals.iastate.edu/cgi-bin/daryl_dev/dominator.py?url='+url+'&file=',line)
		
		if string.find(line, 'ACTION="') != -1: 
                        line = regsub.gsub('ACTION="','ACTION="http://www.pals.iastate.edu/cgi-bin/daryl_dev/dominator.py?url='+url+'&file=',line) 

		if string.find(line, '=POST') != -1: 
                        line = regsub.gsub('=POST','=GET',line)
		if string.find(line, '404 Not Found') != -1: 
			print '<H1><blink>Denied: Dominator will not allow.</blink></H1>'
			sys.exit()
		if string.find(line, 'moved path') != -1: 
                        print '<H1><blink>Denied: Dominator will not allow.</blink></H1>'
                        sys.exit()		
		if string.find(line, '<frameset') != -1: 
                        print '<H1><blink>Denied:</blink> Dominator hates Frames and will not allow them to be shown.</H1>'
                        sys.exit()
		if string.find(line, '<FRAMESET') != -1: 
                        print '<H1><blink>Denied:</blink> Dominator hates Frames and will not allow them to be shown.</H1>'
                        sys.exit()
		if string.find(line, 'JavaScript') != -1: 
                        print '</table><H1><blink>Denied:</blink> The Dominator demands python scripting.</H1></html>'
                        sys.exit()		
		print line

def Main():
	form = FormContent()
 	file = "none"
	url = "http://129.186.177.54/index.html"
	if form.has_key("url"): url = form["url"][0]
        if form.has_key("file"): file = form["file"][0]
	print "Content-type: text/html\n\n"  
	print '<header>\n'
	if file == "none":
		file = url
	print '<base href="'+file+'">'
	print '<title>Dominator</title>\n</header>\n'  
	print "<center><h2>You can not escape the Dominator...</h2></center>"


	html_getter(url, file) 

Main()
